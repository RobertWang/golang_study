# Go æ¯æ—¥ä¸€é¢˜

> ä»Šæ—¥ï¼ˆ2023-04-18ï¼‰çš„é¢˜ç›®å¦‚ä¸‹

ä¸‹é¢è¿™æ®µä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ

```golang
func f(n int) (r int) {
	defer func() {
		r += n
		recover()
	}()

	var f func()

	defer f()
	f = func() {
		r += 2
	}
	return n + 1
}

func main() {
	fmt.Println(f(3))
}
```

<details>
<summary style="cursor: pointer">ğŸ”‘ ç­”æ¡ˆè§£æï¼š</summary>
<div>

å‚è€ƒç­”æ¡ˆåŠè§£æï¼š7ã€‚

---

### 8 æ¥¼

åº”è¯¥æ˜¯ defer æ³¨å†Œå»¶è¿Ÿæ‰§è¡Œå‡½æ•°æ—¶, f æœªåˆå§‹åŒ–, ä¸º nil, f()ä¼š panic, r += 2 ä¸ä¼šæ‰§è¡Œ, è‹¥æŠŠ defer f()ä¸ f = func() {r += 2}æ¢ä¸€ä¸‹ä½ç½®, å€¼å°±æ˜¯ 9 äº†

### 9 æ¥¼

> 6 æ¥¼

```golang
// å…ˆæ‰§è¡Œè¿™ä¸€æ®µä»£ç , ç„¶å r è¢«èµ‹å€¼ä¸º 4
return n+1

// ç„¶åæ‰§è¡Œï¼Œä½†æ˜¯ä¼šè§¦å‘panic
defer f()

// æœ€åæ‰§è¡Œï¼Œr å†åŠ 3 r=7,ç„¶årecover(),æœ€åå‡½æ•°è¿”å› 7
defer func() {
	r += n
	recover()
}()
```

### 12 æ¥¼

ä¸ªäººè§è§£ï¼š

1. è€ƒå¯Ÿäº† defer çš„è°ƒç”¨ï¼Œé€šè¿‡ä¸Šé¢çš„`defer f()`å¯çŸ¥ï¼Œf()æ˜¯æ²¡æœ‰å®šä¹‰çš„ï¼Ÿ(å­˜ç–‘)æ‰€ä»¥æŠ¥äº† panicï¼Œè€Œåœ¨`defer func()`é‡Œé¢çš„`recover()`å¤„ç†äº†è¿™ä¸ª panicï¼Œä¿è¯äº†æ•´ä¸ªç¨‹åºèƒ½å¤Ÿæ‰§è¡Œå®Œ
2. ç„¶åçœ‹ f()å‡½æ•°è¿”å›çš„å€¼ä¸º rï¼Œè€Œä¸æ˜¯ n+1ï¼Œè¿™é‡Œè€ƒå¯Ÿçš„æ˜¯å‡½æ•°çš„è¿”å›è¿™ä¸€å—çš„çŸ¥è¯†ï¼Œæ‰€ä»¥æœ€åçš„ç»“æœä¸æ˜¯`return n+1`è€Œæ˜¯`n+1+n`çš„ç»“æœï¼ˆç¬¬ä¸‰ç‚¹è¯¦ç»†è§£é‡Šï¼‰
3. ä¸ºä»€ä¹ˆä¼šç­‰äº 7ï¼Ÿçœ‹çœ‹æœ€`f()`å‡½æ•°çš„æœ€åä¸€è¡Œä¸º`return n+1`,ä¹Ÿå°±æ˜¯`return 3+1`,å‡½æ•°`f()`çš„è¿”å›å‚æ•°ä¸º`r int`ï¼Œæ‰€ä»¥`r = 3 + 1`,å†åˆ°`defer func()`çš„`r+=n`ä¹Ÿå°±æ˜¯`r = n + 1 + n`å³`r = 3 + 1 + 3`ï¼Œç„¶åè¿”å› r çš„å€¼ï¼Œå°±æ˜¯ 7

### 15 æ¥¼

å¯ä»¥å‚è€ƒ [https://studygolang.com/articles/27408](https://studygolang.com/articles/27408) å¯¹äº defer çš„çŸ¥è¯†ç‚¹

### 40 æ¥¼

è§£é‡Šå¦‚ä¸‹ï¼š

f(3)è°ƒç”¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ return n + 1ï¼Œå³è¿”å›å€¼ä¸º 4ã€‚ æ¥ç€æ‰§è¡Œ defer f()ï¼Œå³æ‰§è¡Œ f å‡½æ•°ï¼Œr çš„å€¼å˜æˆäº† 6ã€‚ æ‰§è¡Œ defer func() {...}()ï¼Œå…¶ä¸­çš„ recover()å‡½æ•°å¯ä»¥ä½¿ç¨‹åºä» panic çŠ¶æ€ä¸­æ¢å¤è¿‡æ¥ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‘ç”Ÿ panicï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸åšä»»ä½•æ“ä½œã€‚ å› æ­¤æœ€ç»ˆçš„è¿”å›å€¼æ˜¯ 4 + 2 + 1 = 7ã€‚

</div>
</details>
