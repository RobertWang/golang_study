# Go æ¯æ—¥ä¸€é¢˜

> ä»Šæ—¥ï¼ˆ2023-09-02ï¼‰çš„é¢˜ç›®å¦‚ä¸‹

Go 1.15 ä¸­ var i interface{} = a ä¼šæœ‰é¢å¤–å †å†…å­˜åˆ†é…å—ï¼Ÿ

å…·ä½“ä»£ç æ˜¯ï¼š

```golang
var a  int = 3
// ä»¥ä¸‹æœ‰é¢å¤–å†…å­˜åˆ†é…å—ï¼Ÿ
var i interface{} = a
```

<details>
<summary style="cursor: pointer">ğŸ”‘ ç­”æ¡ˆè§£æï¼š</summary>
<div>

åœ¨ Go ä¸­ï¼Œæ¥å£è¢«å®ç°ä¸ºä¸€å¯¹æŒ‡é’ˆï¼ˆè¯·å‚é˜… Russ Cox çš„ Go æ•°æ®ç»“æ„ï¼š[æ¥å£](https://research.swtch.com/interfaces)ï¼‰ï¼šæŒ‡å‘æœ‰å…³ç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆå’ŒæŒ‡å‘å€¼çš„æŒ‡é’ˆã€‚å¯ä»¥ç®€å•çš„è¡¨ç¤ºä¸ºï¼š

```golang
type iface struct {
    tab  *itab
    data unsafe.Pointer
}
```

å…¶ä¸­ tab æ˜¯æŒ‡å‘ç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆï¼›data æ˜¯æŒ‡å‘å€¼çš„æŒ‡é’ˆã€‚å› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´æ¥å£æ„å‘³ç€å¿…é¡»åœ¨å †ä¸­åŠ¨æ€åˆ†é…è¯¥å€¼ã€‚

ç„¶è€Œï¼Œ**[Go 1.15 å‘è¡Œè¯´æ˜](https://docs.studygolang.com/doc/go1.15)**åœ¨ runtime éƒ¨åˆ†ä¸­æåˆ°äº†ä¸€ä¸ªæœ‰è¶£çš„æ”¹è¿›ï¼š

>     Converting a small integer value into an interface value no longer causes allocation.

æ„æ€æ˜¯è¯´ï¼Œå°†å°æ•´æ•°è½¬æ¢ä¸ºæ¥å£å€¼ä¸å†éœ€è¦è¿›è¡Œå†…å­˜åˆ†é…ã€‚å°æ•´æ•°æ˜¯æŒ‡ 0 åˆ° 255 ä¹‹é—´çš„æ•°ã€‚

æˆ‘ä»¬å®é™…ç®€å•æµ‹è¯•ä¸€ä¸‹ã€‚

åˆ›å»ºä¸€ä¸ªåŒ… smallintï¼Œåœ¨åŒ…ä¸­åˆ›å»ºæ–‡ä»¶ smallint.goï¼ŒåŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š

```golang
package smallint

func Convert(val int) []interface{} {
    var slice = make([]interface{}, 100)
    for i := 0; i < 100; i++ {
        slice[i] = val
    }

    return slice
}
```

ä¸ºäº†æ›´å¥½çš„çœ‹åˆ°æ•ˆæœï¼Œå‡½æ•°ä¸­è¿›è¡Œäº† 100 æ¬¡ int åˆ° interface çš„è½¬æ¢ã€‚å†™ä¸ªåŸºå‡†æµ‹è¯• smallint_test.goï¼š

```golang
package smallint_test

import (
    "testing"
    "test/smallint"
)

func BenchmarkConvert(b *testing.B) {
    for i := 0; i < b.N; i++ {
        result := smallint.Convert(12)
        _ = result
    }
}
```

åˆ†åˆ«ä½¿ç”¨ Go1.14 å’Œ Go1.15 ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼š

```bash
$ go version
go version go1.14.7 darwin/amd64
$ go test -bench . -benchmem ./...
goos: darwin
goarch: amd64
pkg: test/smallint
BenchmarkConvert-8      569830       1966 ns/op     2592 B/op      101 allocs/op
PASS
ok   test/smallint 1.647s
$ go version
go version go1.15 darwin/amd64
$ go test -bench . -benchmem ./...
goos: darwin
goarch: amd64
pkg: test/smallint
BenchmarkConvert-8     1859451        655 ns/op     1792 B/op        1 allocs/op
PASS
ok   test/smallint 2.178s
```

æ¥ç€è®² smallint_test.go ä¸­è°ƒç”¨ Convert çš„å‚æ•°ç”± 12 æ”¹ä¸º 256ï¼Œå†æ¬¡ä½¿ç”¨ Go1.15 è¿è¡Œï¼Œç»“æœå¦‚ä¸‹ï¼š

```bash
$ go test -bench . -benchmem ./...
goos: darwin
goarch: amd64
pkg: test/smallint
BenchmarkConvert-8      551546       2049 ns/op     2592 B/op      101 allocs/op
PASS
ok   test/smallint 1.502s
```

è¯æ˜äº†ä¸Šé¢æåˆ°çš„ä¼˜åŒ–ç‚¹ã€‚

é‚£ä¹ˆï¼Œä½ æƒ³è¿‡å®ƒå¤§æ¦‚æ€ä¹ˆå®ç°çš„å—ï¼Ÿå› ä¸ºä¸Šæ–‡æåˆ°ï¼ŒGo ä¸­æ¥å£çš„å®ç°ï¼Œä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå­—æ®µæŒ‡å‘æ¥å£å€¼ã€‚ç°åœ¨ç«Ÿç„¶ä¸å†é¢å¤–è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¯´æ˜åšäº†ä»€ä¹ˆç‰¹æ®Šçš„äº‹æƒ…ã€‚

å…¶å®ç­”æ¡ˆéå¸¸ç®€å•ã€‚å¦‚æœä½ å¯¹ Pythonã€Java ç­‰è¯­è¨€ç†Ÿæ‚‰ï¼Œåº”è¯¥çŸ¥é“å¤§æ¦‚å¦‚ä½•å®ç°çš„ã€‚Go ä¸­å¦‚ä½•åšçš„ï¼Œå¯ä»¥åœ¨ [Go CL 216401](https://go-review.googlesource.com/c/go/+/216401) ä¸­ï¼ˆåˆå¹¶åˆ°**[æ­¤æäº¤](https://github.com/golang/go/commit/9828c43288a53d3df75b1f73edad0d037a91dff8)**ä¸­äº†ï¼ŒGitHub ä¸Šæ›´æ˜“äºé˜…è¯»ï¼‰æ‰¾åˆ°ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ Go ä¸­å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„é™æ€æ•°ç»„ï¼Œè¯¥æ•°ç»„ç”± 256 ä¸ªæ•´æ•°ç»„æˆï¼ˆ0 åˆ° 255ï¼‰ã€‚å½“å¿…é¡»åˆ†é…å†…å­˜ä»¥å°†æ•´æ•°å­˜å‚¨åœ¨å †ä¸Šï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæ¥å£çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æ˜¯å¦å®ƒå¯ä»¥åªè¿”å›æŒ‡å‘æ•°ç»„ä¸­é€‚å½“å…ƒç´ çš„æŒ‡é’ˆã€‚è¿™ç§ç»å¸¸ä½¿ç”¨çš„å€¼çš„é™æ€åˆ†é…ï¼Œæ˜¯ä¸€ç§å¾ˆå¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µã€‚ä¾‹å¦‚ï¼ŒPython å¯¹å°æ•´æ•°æ‰§è¡Œç±»ä¼¼çš„æ“ä½œï¼ŒJava ä¹Ÿæœ‰å¸¸é‡æ± ï¼Œè¿›è¡Œç±»ä¼¼çš„ä¼˜åŒ–å¤„ç†ã€‚

å®é™…ä¸Šï¼ŒGo ä»¥å‰æœ‰ä¸€ä¸ªä¼˜åŒ–ï¼Œå¦‚æœä½ å°† 0 è½¬æ¢ä¸ºæ¥å£å€¼ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªæŒ‡å‘ç‰¹æ®Šé™æ€é›¶å€¼çš„æŒ‡é’ˆã€‚è¿™æ¬¡æ–°çš„ 0-255 ä¼˜åŒ–æ›¿ä»£äº†è¯¥å€¼ã€‚

å¯¹å…·ä½“å®ç°ç»†èŠ‚æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥é˜…è¯»ä¸‹ä¸Šæ–‡æåˆ°çš„æäº¤ã€‚

ç­”æ¡ˆè§£ææ¥è‡ªï¼š[https://mp.weixin.qq.com/s/1r0nt8nA3foDRRrbRp4omg](https://mp.weixin.qq.com/s/1r0nt8nA3foDRRrbRp4omg)

---

### 6 æ¥¼

Go 1.15 ä¸­ var i interface{} = a ä¼šæœ‰é¢å¤–å †å†…å­˜åˆ†é…å—ï¼Ÿå°æ•´æ•°è½¬æ¢(0-255)ä¸éœ€è¦ï¼Œé™æ€æ•°ç»„

### 22 æ¥¼

å°†å°æ•´æ•°è½¬æ¢ä¸ºæ¥å£å€¼ä¸å†éœ€è¦è¿›è¡Œå†…å­˜åˆ†é…ã€‚å°æ•´æ•°æ˜¯æŒ‡ 0 åˆ° 255 ä¹‹é—´çš„æ•°ã€‚ Go ä¸­å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„é™æ€æ•°ç»„ï¼Œè¯¥æ•°ç»„ç”± 256 ä¸ªæ•´æ•°ç»„æˆï¼ˆ0 åˆ° 255ï¼‰ã€‚å½“å¿…é¡»åˆ†é…å†…å­˜ä»¥å°†æ•´æ•°å­˜å‚¨åœ¨å †ä¸Šï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæ¥å£çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æ˜¯å¦å®ƒå¯ä»¥åªè¿”å›æŒ‡å‘æ•°ç»„ä¸­é€‚å½“å…ƒç´ çš„æŒ‡é’ˆã€‚

### 34 æ¥¼

æ¥å£å†…å­˜åˆ†é… å°æ•´æ•° ä¸åˆ†é…å†…å­˜ https://mp.weixin.qq.com/s/1r0nt8nA3foDRRrbRp4omg

### 35 æ¥¼

Go 1.15 ä¸­ var i interface{} = a ä¼šæœ‰é¢å¤–å †å†…å­˜åˆ†é…å—ï¼Ÿ
ç­”æ¡ˆï¼šå°æ•´æ•°è½¬æ¢ä¸ºæ¥å£å€¼ä¸å†éœ€è¦è¿›è¡Œå†…å­˜åˆ†é…ã€‚å°æ•´æ•°æ˜¯æŒ‡ 0 åˆ° 255 ä¹‹é—´çš„æ•°ã€‚

</div>
</details>
